<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<title>BarbellAI Chat</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 20px;
		}

		#chat-rooms {
			margin-bottom: 20px;
		}

		#chat-box {
			border: 1px solid #ccc;
			padding: 10px;
			height: 400px;
			overflow-y: auto;
			margin-bottom: 10px;
		}

		#message-input {
			width: 80%;
		}

		#send-btn {
			width: 18%;
		}

		#current-room-name {
			margin: 10px 0;
			font-weight: bold;
		}

		button {
			margin: 2px;
		}
	</style>
</head>

<body>

	<h1>BarbellAI ì±—ë´‡</h1>

	<!-- âœ… í˜„ì¬ ëŒ€í™”ë°© ì´ë¦„ í‘œì‹œ -->
	<h2 id="current-room-name">í˜„ì¬ ëŒ€í™”ë°©: ì—†ìŒ</h2>

	<p>ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”
		<label>
			<input type="radio" name="model" value="gpt" checked="checked">
			GPT
		</label>
		<label>
			<input type="radio" name="model" value="gemini">
			Gemini
		</label>
	</p>
	<label>
		<input type="checkbox" id="streaming-toggle" checked="checked">
		Streaming ì‚¬ìš©
	</label>

	<!-- âœ… ëŒ€í™”ë°© ëª©ë¡ -->
	<div id="chat-rooms"></div>
	<button onclick="newChat()">+ ìƒˆ ëŒ€í™”ë°©</button>

	<!-- âœ… ì±„íŒ…ì°½ -->
	<div id="chat-box"></div>

	<!-- âœ… ë©”ì‹œì§€ ì…ë ¥ì°½ -->
	<input id="message-input" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥..." />
	<button id="send-btn" type="button" onclick="sendMessage()">ë³´ë‚´ê¸°</button>

	<script>
		let currentChatId = null;
		let currentChatTitle = "";
		let isSending = false;
		const token = localStorage.getItem("access_token");

		async function loadChats() {
			const res = await fetch("http://localhost:8000/chat/chats", {
				headers: { "Authorization": `Bearer ${token}` }
			});
			const chats = await res.json();

			const roomsDiv = document.getElementById("chat-rooms");
			roomsDiv.innerHTML = "<h3>ëŒ€í™”ë°© ëª©ë¡</h3>";

			chats.forEach(chat => {
				const container = document.createElement("div");

				const btn = document.createElement("button");
				btn.innerText = chat.title;
				btn.dataset.chatId = chat.chat_id;
				btn.onclick = () => selectChat(chat.chat_id, chat.title);
				container.appendChild(btn);

				const editBtn = document.createElement("button");
				editBtn.innerText = "âœï¸";
				editBtn.onclick = () => renameChat(chat.chat_id);
				container.appendChild(editBtn);

				const deleteBtn = document.createElement("button");
				deleteBtn.innerText = "ğŸ—‘ï¸";
				deleteBtn.onclick = () => deleteChat(chat.chat_id);
				container.appendChild(deleteBtn);

				roomsDiv.appendChild(container);
			});
		}

		function newChat() {
			currentChatId = null;
			currentChatTitle = "";
			updateCurrentRoomName();
			document.getElementById("chat-box").innerHTML = "";
			localStorage.removeItem("currentChatId");
			localStorage.removeItem("currentChatTitle");
		}

		async function selectChat(chatId, title) {
			currentChatId = chatId;
			currentChatTitle = title;
			updateCurrentRoomName();
			loadMessages();
			saveChatInfo();
		}

		function updateCurrentRoomName() {
			document.getElementById("current-room-name").innerText = currentChatTitle ? `í˜„ì¬ ëŒ€í™”ë°©: ${currentChatTitle}` : "í˜„ì¬ ëŒ€í™”ë°©: ì—†ìŒ";
		}

		function saveChatInfo() {
			localStorage.setItem("currentChatId", currentChatId || "");
			localStorage.setItem("currentChatTitle", currentChatTitle || "");
		}

		async function loadMessages() {
			if (!currentChatId) return;

			const res = await fetch(`http://localhost:8000/chat/chats/${currentChatId}/messages`, {
				headers: { "Authorization": `Bearer ${token}` }
			});
			const messages = await res.json();

			const chatBox = document.getElementById("chat-box");
			chatBox.innerHTML = "";

			messages.forEach(m => appendMessage(m.role, m.content));
		}

		function appendMessage(role, content) {
			const chatBox = document.getElementById("chat-box");
			const div = document.createElement("div");
			div.innerHTML = `<b>${role}:</b> ${content}`;
			chatBox.appendChild(div);
			chatBox.scrollTop = chatBox.scrollHeight;
		}

		async function sendMessage() {
			if (isSending) return;
			isSending = true;

			const input = document.getElementById("message-input");
			const content = input.value.trim();
			if (!content) {
				isSending = false;
				return;
			}

			input.value = "";
			appendMessage("user", content);

			// âœ… ëŒ€í™”ë°© ì—†ìœ¼ë©´ ìƒì„±
			if (!currentChatId) {
				const now = new Date();
				const title = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()} ${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;

				const res = await fetch("http://localhost:8000/chat/chats", {
					method: "POST",
					headers: {
						"Authorization": `Bearer ${token}`,
						"Content-Type": "application/json"
					},
					body: JSON.stringify({ title })
				});
				const chat = await res.json();
				currentChatId = chat.chat_id;
				currentChatTitle = chat.title;
				updateCurrentRoomName();
				saveChatInfo();
				await loadChats();
			}

			const isStreaming = document.getElementById("streaming-toggle").checked;
			const selectedModel = document.querySelector('input[name="model"]:checked').value;

			if (isStreaming) {
				// âœ… ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ
				const res = await fetch(`http://localhost:8000/chat/chats/${currentChatId}/messages/stream`, {
					method: "POST",
					headers: {
						"Authorization": `Bearer ${token}`,
						"Content-Type": "application/json"
					},
					body: JSON.stringify({
						content: content,
						model: selectedModel 
					})
				});

				const reader = res.body.getReader();
				const decoder = new TextDecoder();
				let fullAnswer = "";

				const chatBox = document.getElementById("chat-box");
				const assistantDiv = document.createElement("div");
				assistantDiv.innerHTML = "<b>assistant:</b> ";
				chatBox.appendChild(assistantDiv);

				while (true) {
					const { done, value } = await reader.read();
					if (done) break;
					const chunk = decoder.decode(value);
					fullAnswer += chunk;
					assistantDiv.innerHTML = `<b>assistant:</b> ${fullAnswer}`;
					chatBox.scrollTop = chatBox.scrollHeight;
				}
			} else {
				// âœ… ì¼ë°˜ ëª¨ë“œ
				const res = await fetch(`http://localhost:8000/chat/chats/${currentChatId}/messages`, {
					method: "POST",
					headers: {
						"Authorization": `Bearer ${token}`,
						"Content-Type": "application/json"
					},
					body: JSON.stringify({
						content: content,
						model: selectedModel,
					})
				});
				const data = await res.json();
				appendMessage("assistant", data.assistant);
			}

			isSending = false;
		}

		document.getElementById("message-input").addEventListener("keydown", function (event) {
			if (event.key === "Enter" && !event.repeat) {
				event.preventDefault();
				sendMessage();
			}
		});

		async function renameChat(chatId) {
			const newTitle = prompt("ìƒˆ ëŒ€í™”ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
			if (!newTitle) return;

			await fetch(`http://localhost:8000/chat/chats/${chatId}`, {
				method: "PUT",
				headers: {
					"Authorization": `Bearer ${token}`,
					"Content-Type": "application/json"
				},
				body: JSON.stringify({ title: newTitle })
			});

			if (chatId === currentChatId) {
				currentChatTitle = newTitle;
				updateCurrentRoomName();
				saveChatInfo();
			}

			await loadChats();
		}

		async function deleteChat(chatId) {
			if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

			await fetch(`http://localhost:8000/chat/chats/${chatId}`, {
				method: "DELETE",
				headers: { "Authorization": `Bearer ${token}` }
			});

			if (chatId === currentChatId) {
				currentChatId = null;
				currentChatTitle = "";
				updateCurrentRoomName();
				saveChatInfo();
				document.getElementById("chat-box").innerHTML = "";
			}

			await loadChats();
		}

		function init() {
			currentChatId = localStorage.getItem("currentChatId");
			currentChatTitle = localStorage.getItem("currentChatTitle");
			if (currentChatId && currentChatTitle) {
				updateCurrentRoomName();
				loadMessages();
			}
			loadChats();
		}

		init();
	</script>

</body>

</html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ë©”ì¸ í˜ì´ì§€</title>
</head>
<body>
  <h1>ë‰´ìŠ¤ & ê³µì‹œ ê²Œì‹œíŒ</h1>
  <div id="content"></div>

  <!-- âœ… ê²Œì‹œíŒ í•„í„° UI -->
  <h2>ğŸ—‚ï¸ ë‰´ìŠ¤ & ê³µì‹œ ê²Œì‹œíŒ</h2>
  <select id="feed-type" onchange="loadFeed()">
    <option value="all">ì „ì²´</option>
    <option value="news">ë‰´ìŠ¤ë§Œ</option>
    <option value="disclosure">ê³µì‹œë§Œ</option>
    <option value="favorites">ì¦ê²¨ì°¾ê¸° ê¸°ì—…ë§Œ</option>
  </select>
  <ul id="feed-list"></ul>

  <!-- âœ… ê¸°ì—… ëª©ë¡ UI -->
  <h2>ì „ì²´ ê¸°ì—… ëª©ë¡</h2>
  <ul id="company-list"></ul>

  <!-- âœ… ê¸°ëŠ¥ ë²„íŠ¼ -->
  <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  <button onclick="removeToken()">í† í° ì‚­ì œ</button>
  <button onclick="checkToken()">í† í° ìœ íš¨ì„± í™•ì¸</button>

  <script>
    const token = localStorage.getItem("access_token");

    // âœ… ë¡œê·¸ì¸ ì¸ì¦ ì²´í¬ + ì´ˆê¸° ë°ì´í„° ë¡œë”©
    (async function checkAccess() {
      if (!token) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "index.html";
        return;
      }

      try {
        const res = await fetch("http://localhost:8000/auth/check", {
          method: "GET",
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) throw new Error("í† í° ìœ íš¨ì„± ì‹¤íŒ¨");

        const data = await res.json();
        document.getElementById("content").innerText = data.message;

        loadCompanies();
        loadFeed();
      } catch (err) {
        alert("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
        localStorage.removeItem("access_token");
        window.location.href = "index.html";
      }
    })();

    // âœ… ì „ì²´ ê¸°ì—… + ì¦ê²¨ì°¾ê¸° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadCompanies() {
			const token = localStorage.getItem("access_token");
      const [companyRes, favRes] = await Promise.all([
        fetch("http://localhost:8000/user/companies", {
          headers: { Authorization: `Bearer ${token}` }
        }),
        fetch("http://localhost:8000/user/favorites", {
          headers: { Authorization: `Bearer ${token}` }
        })
      ]);

      const companies = await companyRes.json();
      const favorites = (await favRes.json()).favorites;
      renderCompanyList(companies, favorites);
    }

    // âœ… ê¸°ì—… ëª©ë¡ ë Œë”ë§
    function renderCompanyList(companies, favorites) {
      const ul = document.getElementById("company-list");
      ul.innerHTML = "";

      companies.forEach((company) => {
        const li = document.createElement("li");
        const isFav = favorites.includes(company.ticker);

        li.innerHTML = `
          <strong>${company.name}</strong> (${company.ticker})
          <button onclick="${isFav
            ? `removeFavorite('${company.ticker}')`
            : `addFavorite('${company.ticker}')`
          }">
            ${isFav ? "âŒ ì‚­ì œ" : "â­ ì¶”ê°€"}
          </button>
        `;
        ul.appendChild(li);
      });
    }

    // âœ… ì¦ê²¨ì°¾ê¸° ì¶”ê°€
    async function addFavorite(ticker) {
			const token = localStorage.getItem("access_token");
      await fetch("http://localhost:8000/user/favorites", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ ticker })
      });
      loadCompanies();
      loadFeed();
    }

    // âœ… ì¦ê²¨ì°¾ê¸° ì œê±°
    async function removeFavorite(ticker) {
			const token = localStorage.getItem("access_token");
      await fetch("http://localhost:8000/user/favorites", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ ticker })
      });
      loadCompanies();
      loadFeed();
    }

    // âœ… ê²Œì‹œíŒ í•„í„° ë¡œë”©
    async function loadFeed() {
			
			const token = localStorage.getItem("access_token");
      const type = document.getElementById("feed-type").value;

      let url = "http://localhost:8000/posts/";
      if (type === "news") url += "news";
      else if (type === "disclosure") url += "disclosures";
      else if (type === "favorites") url += "my-feed";
      else url += "all";

      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.ok) {
        alert("ê²Œì‹œíŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const items = await res.json();
      renderFeed(items);
    }

    // âœ… ê²Œì‹œê¸€ ìµœì‹ ìˆœ ë Œë”ë§
    function renderFeed(items) {
      const ul = document.getElementById("feed-list");
      ul.innerHTML = "";

      const sorted = [...items].sort((a, b) => new Date(b.date) - new Date(a.date));

      sorted.forEach((item) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>[${item.ticker}]</strong> ${item.title} (${item.date})
          <span style="color: gray;">[${item.type}]</span>
        `;
        ul.appendChild(li);
      });
    }

    // âœ… ë¡œê·¸ì•„ì›ƒ
    function logout() {
      localStorage.removeItem("access_token");
      alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
      window.location.href = "index.html";
    }

    // âœ… í† í° ì‚­ì œ
    function removeToken() {
      localStorage.removeItem("access_token");
      alert("í† í°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    // âœ… í† í° ìœ íš¨ì„± í™•ì¸
    async function checkToken() {
			const token = localStorage.getItem("access_token");
      if (!token) {
        alert("ì €ì¥ëœ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const res = await fetch("http://localhost:8000/auth/check", {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (res.ok) {
        const data = await res.json();
        alert(`ìœ íš¨í•œ í† í°ì…ë‹ˆë‹¤: ${data.message}`);
      } else {
        alert("ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì´ê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      }
    }
  </script>
</body>
</html>
